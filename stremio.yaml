package:
  name: stremio
  version: 4.4.169
  epoch: 0
  description: Modern media center for online video content
  copyright:
    - license: GPL-3.0-or-later
  dependencies:
    runtime:
      - libdrm
      - libnspr
      - libnss
      - librsvg
      - mesa
      - mesa-gbm
      - nodejs
      - qt5-qtbase
      - qt5-qtdeclarative
      - qt5-qtquickcontrols
      - qt5-qtquickcontrols2
      - qt5-qtwebchannel
      - qt5-qtwebengine

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - cmake
      - libnspr-dev
      - libnss-dev
      - librsvg
      - mpv-dev
      - nodejs
      - npm
      - openssl-dev
      - pkgconf
      - qt5-qtbase-dev
      - qt5-qtdeclarative-dev
      - qt5-qtquickcontrols-dev
      - qt5-qtquickcontrols2-dev
      - qt5-qtwebchannel-dev
      - qt5-qtwebengine-dev
      - rsvg-convert
      - wolfi-base

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/Stremio/stremio-shell
      tag: v${{package.version}}
      expected-commit: 0589927cb53bc68e09776ec94ce3860b64ca10a4

  - uses: patch
    with:
      patches: stremio/001-release-makefile-fhs.patch

  - uses: patch
    with:
      patches: stremio/002-cmake-add-singleapp.patch

  - uses: patch
    with:
      patches: stremio/003-main-qtwebengine-singleapp.patch

  - uses: patch
    with:
      patches: stremio/004-fhs-server-paths.patch

  - uses: patch
    with:
      patches: stremio/005-process-environment-fix.patch

  - uses: patch
    with:
      patches: stremio/006-cmake-remove-singleapp-dep.patch

  - uses: patch
    with:
      patches: stremio/007-remove-qthelper-deprecated.patch

  - uses: patch
    with:
      patches: stremio/008-optional-system-tray.patch

  - uses: patch
    with:
      patches: stremio/009-add-compatiblesingleapp.patch

  - name: Generate icons
    runs: |
      mkdir -p icons
      cd icons
      for size in 16 22 24 32 64 128; do
        rsvg-convert ../images/stremio.svg -w $size -o smartcode-stremio_${size}.png
        rsvg-convert ../images/stremio_tray_white.svg -w $size -o smartcode-stremio-tray_${size}.png
      done

  - name: Build with CMake
    runs: |
      export QT_SELECT=5
      export QT_DEFAULT_MAJOR_VERSION=5
      export CMAKE_PREFIX_PATH=/usr/lib64/cmake:/usr/lib/cmake:/usr

      mkdir -p build
      cd build
      cmake -G"Unix Makefiles" \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DCMAKE_CXX_FLAGS="-fstack-protector-strong -D_FORTIFY_SOURCE=2" \
        -DCMAKE_C_FLAGS="-fstack-protector-strong -D_FORTIFY_SOURCE=2" \
        ..
      make -j$(nproc)

  - name: Install files
    runs: |
      # Install binary to libexec (not directly in PATH)
      install -Dm755 build/stremio "${{targets.destdir}}"/usr/libexec/stremio/stremio

      # Create wrapper script with intelligent environment detection
      mkdir -p "${{targets.destdir}}"/usr/bin
      cat > "${{targets.destdir}}"/usr/bin/stremio << 'WRAPPER'
      #!/bin/sh
      # Intelligent environment detection: container vs bare metal

      # Detect container environment
      if [ -f /.dockerenv ] || [ -f /run/.containerenv ] || grep -q '/docker/\|/lxc/' /proc/1/cgroup 2>/dev/null; then
          # Container: ALWAYS use software rendering
          # GLX rarely works in containers even with GPU passthrough
          export QT_XCB_GL_INTEGRATION=none
          export QT_QUICK_BACKEND=software
      else
          # Bare metal: try hardware acceleration first
          if [ -e /dev/dri/card0 ]; then
              export LIBGL_DRIVERS_PATH=/usr/lib/xorg/modules/dri
              export QT_XCB_GL_INTEGRATION=xcb_glx
          else
              # Fallback to software if no GPU detected
              export QT_QUICK_BACKEND=software
          fi
      fi

      # Common settings
      export QT_AUTO_SCREEN_SCALE_FACTOR="${QT_AUTO_SCREEN_SCALE_FACTOR:-1}"
      export QT_QPA_PLATFORM="${QT_QPA_PLATFORM:-xcb}"

      # Disable QtWebEngine sandbox (required for container compatibility)
      export QTWEBENGINE_DISABLE_SANDBOX=1

      exec /usr/libexec/stremio/stremio "$@"
      WRAPPER
      chmod 755 "${{targets.destdir}}"/usr/bin/stremio

      # Install desktop file
      install -Dm644 stremio.desktop "${{targets.destdir}}"/usr/share/applications/stremio.desktop

      # Install icons (proper FreeDesktop hierarchy)
      for size in 16 22 24 32 64 128; do
        install -Dm644 "icons/smartcode-stremio_${size}.png" \
          "${{targets.destdir}}"/usr/share/icons/hicolor/${size}x${size}/apps/stremio.png
      done

      # Install tray icons
      mkdir -p "${{targets.destdir}}"/usr/share/stremio/icons/
      for size in 16 22 24 32 64 128; do
        install -Dm644 "icons/smartcode-stremio-tray_${size}.png" \
          "${{targets.destdir}}"/usr/share/stremio/icons/
      done

  - uses: strip

subpackages:
  - name: stremio-doc
    description: Stremio documentation
    pipeline
    # test:
    #   pipeline:
    #     # - uses: test/no-docs:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/share/doc/stremio
          install -Dm644 README.md "${{targets.subpkgdir}}"/usr/share/doc/stremio/
          install -Dm644 LICENSE.md "${{targets.subpkgdir}}"/usr/share/doc/stremio/

update:
  enabled: true
  github:
    identifier: Stremio/stremio-shell
    strip-prefix: v
    use-tag: true

test:
  environment:
    contents:
      packages:
        - nodejs
        - qt5-qtbase
        - qt5-qtdeclarative
        - qt5-qtquickcontrols
        - qt5-qtquickcontrols2
        - qt5-qtwebengine
  pipeline
  # - uses: test/no-docs:
    - name: Test binary exists and is executable
      runs: |
        test -f /usr/bin/stremio
        test -x /usr/bin/stremio
    - name: Test wrapper script
      runs: |
        test -f /usr/libexec/stremio/stremio
        test -x /usr/libexec/stremio/stremio
    - name: Test desktop file
      runs: |
        test -f /usr/share/applications/stremio.desktop
        grep -q "Exec=stremio" /usr/share/applications/stremio.desktop
    - name: Test icons installed
      runs: |
        test -f /usr/share/icons/hicolor/16x16/apps/stremio.png
        test -f /usr/share/icons/hicolor/128x128/apps/stremio.png
    - name: Verify library dependencies
      runs: |
        ldd /usr/libexec/stremio/stremio | grep -q libQt5WebEngine
        ldd /usr/libexec/stremio/stremio | grep -q libmpv
        ldd /usr/libexec/stremio/stremio | grep -q libcrypto
    - name: Test security hardening flags
      runs: |
        # Verify stack protector and FORTIFY_SOURCE were applied
        readelf -p .comment /usr/libexec/stremio/stremio | grep -q GCC || true
